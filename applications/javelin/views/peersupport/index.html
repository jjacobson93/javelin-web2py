{{extend 'main.html'}}

{{block content}}
<div class="container">
	<div class="row">
		<div class="col-12 col-md-12">
			<h1 class="pull-left">Peer Support <i class="icon-heart"></i></h1>
			<a class="btn btn-lg btn-danger pull-right btn-long" href="{{=URL('peersupport', 'new_issue')}}" style="margin: 8px 0;">
				<i class="icon-warning-sign"></i>New Issue
			</a>
		</div>
	</div>
	<div class="row">
		<div class="col-12 col-md-12">
			<ul class="nav nav-pills">
				<li class="active"><a href="#issues" data-toggle="tab">All Issues</a></li>
				{{if auth.has_membership('standard') or auth.has_membership('admin'):}}
				<li><a href="#reports" data-toggle="tab">Reports</a></li>
				{{pass}}
			</ul>
		</div>
	</div>

	<div class="row">
		<div class="col-12 col-md-12">
			<div class="tab-content" style="overflow: initial">
				<div class="tab-pane active fade in" id="issues">
					{{if issues:}}
					<table class="table table-striped sortable table-mobile">
						<thead>
							<tr>
								<th>Issue ID</th>
								<th>Date Created</th>
								<th>Date Updated</th>
								<th>Student Name</th>
								<th>Peer Support Student</th>
								<th>Need Follow Up?</th>
								<th>Refer to PS?</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{{for i in issues:}}
							<tr>
								<td>{{=i.student_issue.id}}</td>
								<td>{{=i.student_issue.timestamp}}</td>
								<td>{{=i.student_issue.updated}}</td>
								<td>{{=' '.join([i.student.first_name, i.student.last_name])}}</td>
								<td>{{=' '.join([i.peer_support.first_name, i.peer_support.last_name])}}</td>
								<td>{{='Yes' if i.student_issue.need_follow_up else 'No'}}</td>
								<td>{{='Yes' if i.student_issue.refer else 'No'}}</td>
								<td>
									<div class="btn-group">
										<a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
											Actions <span class="caret"></span>
										</a>
										<ul class="dropdown-menu" style="margin-left: -77px">
											<li>
												<a href="{{=URL(a='javelin', c='peersupport', f='issue', vars={'id': str(i.student_issue.id)})}}">
													<i class="icon-eye-open"></i>View
												</a>
												</li>
											<li>
												<a href="{{=URL(a='javelin', c='peersupport', f='follow_up', vars={'id': str(i.student_issue.id)})}}">
													<i class="icon-refresh"></i>Follow Up
												</a>
											</li>
										</ul>
									</div>
								</td>
							</tr>
							{{pass}}
						</tbody>
					</table>
					{{else:}}
					<div class="alert alert-info" style="padding-top: 20px; padding-bottom: 15px; margin-top: 10px">
						<h4>No Issues</h4>
					</div>
					{{pass}}
				</div>

				{{if auth.has_membership('standard') or auth.has_membership('admin'):}}
				<div class="tab-pane fade in" id="reports">
					<a class="btn btn-primary" href="#" id="generate_report_btn" data-loading-text="Loading..." style="margin-top: 10px">Generate Report</a>
					{{if reports:}}
					<table class="table table-striped">
						<thead>
							<tr>
								<th>Filename</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{{for r in reports:}}
							<tr>
								<td>{{=r.name}}</td>
								<td><a class="btn" href="{{=URL('default', 'download', r.file)}}">Download</a></td>
							</tr>
							{{pass}}
						</tbody>
					</table>
					{{else:}}
					<div class="alert alert-info" style="padding-top: 20px; padding-bottom: 15px; margin-top: 10px">
						<h4>No Reports</h4>
					</div>
					{{pass}}
				</div>
				{{pass}}
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	$(function() {
		$('#generate_report_btn').on('click', function() {
			$('#generate_report_btn').button('loading');

			$.ajax({
				'type': 'POST',
				'url': '/peersupport/call/json/generate_report',
				'dataType': 'json',
				success: function(data) {
					displaySuccess("Report has been generated! Now downloading.");
					$('#generate_report_btn').button('reset');
					window.location.href = '/download/' + data.filename; 
				},
				error: function() {
					displayError("There was a problem generating the report.");
				}
			});
		});
	});
</script>
{{end}}